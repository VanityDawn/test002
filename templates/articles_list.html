{% extends "base.html" %}
{% block content %}
<div class="layui-card">
  <div class="layui-card-header">已采集数据</div>
  <div class="layui-card-body">
    <table class="layui-table">
      <thead>
        <tr><th>ID</th><th>标题</th><th>来源</th><th>原始URL</th><th>时间</th><th>深度状态</th><th>操作</th></tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r['id'] }}</td>
          <td>{{ r['title'] }}</td>
          <td>{{ r['source'] }}</td>
          <td><a class="layui-font-blue" target="_blank" href="{{ r['original_url'] }}">打开</a></td>
          <td>{{ r['created_at'] }}</td>
          <td class="deep-status">{{ '已执行' if r['deep_done'] else '未执行' }}</td>
          <td>
            {% if session.get('role_name') == 'admin' %}
            <button class="layui-btn layui-btn-primary layui-btn-xs btn-deep" data-id="{{ r['id'] }}" {% if r['deep_done'] %}disabled{% endif %}>深度采集</button>
            <form method="post" action="{{ url_for('articles_delete', article_id=r['id']) }}" style="display:inline;">
              <button class="layui-btn layui-btn-danger layui-btn-xs">删除</button>
            </form>
            {% else %}
            <span class="layui-font-12" style="opacity:.7;">无权限</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
layui.use(function(){
  var $ = layui.$; var layer = layui.layer;
  $('.btn-deep').on('click', function(){
    var id = $(this).data('id'); var $btn=$(this);
    $btn.prop('disabled', true);
    $.ajax({
      url: '/api/articles/deep/' + id,
      method: 'POST',
      success: function(r){
        layer.msg('深度采集完成');
        $btn.closest('tr').find('.deep-status').text('已执行');
      },
      error: function(){
        layer.msg('深度采集失败');
        $btn.prop('disabled', false);
      }
    });
  });
});
</script>
{% endblock %}
